<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Adventure</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #0d1117, #161b22); /* Darker, more subtle background */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            color: #e0e6ed; /* Light text for contrast */
        }
        .game-container {
            background-color: #161b22; /* Dark blue-grey, reminiscent of old RPG menu backgrounds */
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6), 0 0 0 4px #4a5568; /* Stronger shadow, subtle outer border */
            padding: 2.5rem;
            width: 100%;
            max-width: 600px;
            text-align: center;
            border: 2px solid #63b3ed; /* Blue border for a classic look */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        h1 {
            color: #ffeb3b; /* Vibrant gold for main title */
            font-size: 2.8rem;
            font-weight: 900; /* Extra bold */
            margin-bottom: 1rem;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7), 0 0 10px #ffeb3b; /* More pronounced glow */
            letter-spacing: 0.05em;
        }
        .section-title {
            color: #a7d9ff; /* Lighter blue for section titles */
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .btn {
            padding: 0.85rem 1.75rem;
            border-radius: 0.75rem;
            font-weight: 700; /* Bolder text */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2); /* More depth */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            border: 2px solid; /* Add a border for definition */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            background: linear-gradient(to bottom, #63b3ed, #4299e1); /* Blue gradient */
            color: white;
            border-color: #3182ce;
        }
        .btn-primary:hover {
            background: linear-gradient(to bottom, #4299e1, #3182ce);
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(to bottom, #4a5568, #2d3748); /* Darker grey gradient */
            color: #e0e6ed;
            border-color: #2d3748;
        }
        .btn-secondary:hover {
            background: linear-gradient(to bottom, #2d3748, #1a202c);
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        .btn-danger {
            background: linear-gradient(to bottom, #e53e3e, #c53030); /* Red gradient */
            color: white;
            border-color: #9b2c2c;
        }
        .btn-danger:hover {
            background: linear-gradient(to bottom, #c53030, #9b2c2c);
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .btn-success {
            background: linear-gradient(to bottom, #48bb78, #38a169); /* Green gradient */
            color: white;
            border-color: #2f855a;
        }
        .btn-success:hover {
            background: linear-gradient(to bottom, #38a169, #2f855a);
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .message-box {
            background-color: #0d1117; /* Very dark background for message box */
            border: 2px solid #a7d9ff; /* Light blue border */
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: #e0e6ed;
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); /* Inner shadow for depth */
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            text-align: left;
            font-size: 0.95rem;
            color: #cbd5e0; /* Slightly lighter text for stats */
        }
        .stats-grid span {
            display: block;
            padding: 0.25rem 0;
        }
        .progress-bar-container {
            background-color: #2d3748; /* Darker background for empty bar */
            border-radius: 0.5rem;
            height: 1rem;
            overflow: hidden;
            margin-top: 0.5rem;
            border: 1px solid #4a5568; /* Border for the bar container */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .progress-bar {
            background: linear-gradient(to right, #48bb78, #38a169); /* Green gradient for XP */
            height: 100%;
            width: 0%;
            border-radius: 0.5rem;
            transition: width 0.3s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.2);
        }
        /* HP Bar Colors */
        .hp-bar .progress-bar.green-hp {
            background: linear-gradient(to right, #48bb78, #38a169); /* Green */
        }
        .hp-bar .progress-bar.yellow-hp {
            background: linear-gradient(to right, #f6e05e, #d69e2e); /* Yellow */
        }
        .hp-bar .progress-bar.red-hp {
            background: linear-gradient(to right, #fc8181, #e53e3e); /* Red */
        }

        .shop-items, .hire-options, .main-menu-options, .equipped-items-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        .shop-item, .hire-option, .main-menu-option, .equipped-item {
            background-color: #2d3748; /* Darker background for items */
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            border: 1px solid #4a5568; /* Subtle border */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .shop-item:hover, .hire-option:hover, .main-menu-option:hover, .equipped-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        .shop-item-name, .hire-option-name, .main-menu-option-name, .equipped-item-name {
            font-weight: bold;
            color: #ffeb3b; /* Gold for item names */
            margin-bottom: 0.5rem;
        }
        .shop-item-cost, .hire-option-cost, .equipped-item-sell-value {
            font-size: 0.9rem;
            color: #a7d9ff; /* Light blue for costs */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1a202c; /* Darker modal background */
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.7), 0 0 0 5px #ffeb3b; /* Gold border for modals */
            width: 90%;
            max-width: 450px; /* Slightly wider modal */
            color: #e0e6ed;
            text-align: center;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.8rem; /* Larger close button */
            color: #a0aec0;
            cursor: pointer;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .modal-close-btn:hover {
            color: #ffeb3b; /* Gold on hover */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .game-container {
                padding: 1.5rem;
                gap: 1rem;
            }
            h1 {
                font-size: 2rem;
            }
            .section-title {
                font-size: 1.4rem;
            }
            .btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
            .stats-grid {
                grid-template-columns: 1fr; /* Stack stats on small screens */
            }
            .shop-items, .hire-options, .main-menu-options, .equipped-items-list {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Smaller grid items */
                gap: 0.75rem;
            }
            .modal-content {
                padding: 1.5rem;
            }
        }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .flash {
            animation: flash 0.2s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .explode {
            animation: explode 0.5s forwards;
        }

        /* Victory Animation */
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #ffeb3b; /* Gold */
            border-radius: 50%;
            animation: confetti-fall 3s ease-in-out forwards;
            opacity: 0;
        }
        .confetti:nth-child(2n) { background-color: #63b3ed; } /* Blue */
        .confetti:nth-child(3n) { background-color: #48bb78; } /* Green */
        .confetti:nth-child(4n) { background-color: #e53e3e; } /* Red */
        .confetti:nth-child(5n) { background-color: #a7d9ff; } /* Light Blue */

        /* Specific styles for monster abilities */
        .shield-active {
            border: 3px solid #63b3ed; /* Blue border for shield */
            box-shadow: 0 0 15px rgba(99, 179, 237, 0.7);
        }
        .debuff-active {
            filter: grayscale(80%); /* Grey out player stats to show debuff */
        }
        .immunity-active {
            border: 3px solid #ffeb3b; /* Gold border for immunity */
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.7);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="game-container" id="game-container">
        <h1>‚ú® RPG Adventure ‚ú®</h1>

        <!-- Occupation Selection Screen -->
        <div id="occupation-screen" class="space-y-6">
            <h2 class="section-title">Choose Your Path</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button class="btn btn-primary flex-col p-4" onclick="selectOccupation('Warrior')">
                    <span class="text-3xl">üõ°Ô∏è</span>
                    <span class="mt-2 text-lg">Warrior</span>
                    <span class="text-sm text-gray-200">High HP, Good Defence</span>
                </button>
                <button class="btn btn-primary flex-col p-4" onclick="selectOccupation('Mage')">
                    <span class="text-3xl">üîÆ</span>
                    <span class="mt-2 text-lg">Mage</span>
                    <span class="text-sm text-gray-200">Powerful Skill, Low HP</span>
                </button>
                <button class="btn btn-primary flex-col p-4" onclick="selectOccupation('Rogue')">
                    <span class="text-3xl">üó°Ô∏è</span>
                    <span class="mt-2 text-lg">Rogue</span>
                    <span class="text-sm text-gray-200">Multi-hit Chance, Low HP</span>
                </button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden space-y-6">
            <div class="message-box" id="game-message">Welcome, adventurer!</div>

            <!-- Player Stats -->
            <div class="bg-gray-700 p-4 rounded-xl shadow-inner" id="player-stats-display">
                <h3 class="text-xl font-semibold mb-2 text-yellow-300">Your Hero</h3>
                <div class="stats-grid">
                    <span>Occupation: <span id="player-occupation"></span></span>
                    <span>Level: <span id="player-level"></span></span>
                    <span>Attack: <span id="player-attack"></span></span>
                    <span>Defence: <span id="player-defence"></span></span>
                    <span>Coins: <span id="player-coins"></span></span>
                    <span>Potions: <span id="player-potions"></span></span>
                    <span>Equipment: <span id="player-equipment">None</span></span>
                    <span id="companion-display">Companion: None</span>
                </div>
                <div class="mt-4">
                    <div class="text-sm font-medium mb-1">HP: <span id="player-hp-text"></span></div>
                    <div class="progress-bar-container hp-bar">
                        <div class="progress-bar" id="player-hp-bar"></div>
                    </div>
                </div>
                <div class="mt-2">
                    <div class="text-sm font-medium mb-1">XP: <span id="player-xp-text"></span></div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="player-xp-bar"></div>
                    </div>
                </div>
            </div>

            <!-- Enemy Stats (hidden initially) -->
            <div id="enemy-display" class="bg-gray-700 p-4 rounded-xl shadow-inner hidden">
                <h3 class="text-xl font-semibold mb-2 text-red-400">Enemy: <span id="enemy-icon"></span> <span id="enemy-name"></span></h3>
                <div class="stats-grid">
                    <span>Attack: <span id="enemy-attack"></span></span>
                    <span>Defence: <span id="enemy-defence"></span></span>
                </div>
                <div class="mt-4">
                    <div class="text-sm font-medium mb-1">HP: <span id="enemy-hp-text"></span></div>
                    <div class="progress-bar-container hp-bar">
                        <div class="progress-bar" id="enemy-hp-bar"></div>
                    </div>
                </div>
            </div>

            <!-- Main Menu Actions -->
            <div id="main-menu-actions" class="flex justify-center gap-4 flex-wrap">
                <button class="btn btn-primary main-menu-option" onclick="explore()">
                    <span class="text-xl">üå≤</span> Explore
                </button>
                <button class="btn btn-primary main-menu-option" onclick="showShop()">
                    <span class="text-xl">üõçÔ∏è</span> Shop
                </button>
                <button class="btn btn-primary main-menu-option" onclick="showHireScreen()">
                    <span class="text-xl">ü§ù</span> Bar
                </button>
                <button class="btn btn-success main-menu-option" id="use-potion-out-of-battle-btn" onclick="usePotionOutOfBattle()">
                    <span class="text-xl">üß™ Potion (<span id="potion-count-main-menu">0</span>)</span>
                </button>
            </div>

            <!-- Battle Actions -->
            <div id="battle-actions" class="flex justify-center gap-4 flex-wrap hidden">
                <button class="btn btn-primary" id="attack-btn" onclick="attack()">
                    <span class="text-xl">‚öîÔ∏è</span> Attack
                </button>
                <button class="btn btn-primary" id="skill-btn" onclick="useSkill()">
                    <span class="text-xl" id="skill-icon">‚ú®</span> <span id="skill-name">Skill</span>
                </button>
                <button class="btn btn-success" id="potion-btn" onclick="usePotion()">
                    <span class="text-xl">üß™ Potion (<span id="potion-count" class="text-base">0</span>)</span>
                </button>
                <button class="btn btn-secondary" id="flee-btn" onclick="flee()">
                    <span class="text-xl">üèÉ‚Äç‚ôÇÔ∏è</span> Flee
                </button>
            </div>

            <!-- Shop Screen -->
            <div id="shop-screen" class="hidden space-y-4">
                <h2 class="section-title">The Wanderer's Shop</h2>
                <div class="shop-items" id="shop-items-container">
                    <!-- Shop items will be loaded here -->
                </div>
                <h3 class="section-title mt-6">Your Equipment</h3>
                <div class="equipped-items-list" id="equipped-items-sell-container">
                    <!-- Equipped items for selling will be loaded here -->
                </div>
                <button class="btn btn-secondary w-full mt-4" onclick="returnToMainMenu()">Leave Shop</button>
            </div>

            <!-- Hire Member Screen -->
            <div id="hire-screen" class="hidden space-y-4">
                <h2 class="section-title">Hire a Companion</h2>
                <div class="hire-options" id="hire-options-container">
                    <!-- Hire options will be loaded here -->
                </div>
                <button class="btn btn-secondary w-full" onclick="returnToMainMenu()">No Thanks</button>
            </div>

            <!-- Confirmation Modal (for restart) -->
            <div id="confirm-modal" class="hidden modal-overlay">
                <div class="modal-content">
                    <button class="modal-close-btn" onclick="confirmRestart(false)">&times;</button>
                    <div class="message-box">Are you sure you want to restart the game?</div>
                    <div class="flex justify-center gap-4 mt-4">
                        <button class="btn btn-success" onclick="confirmRestart(true)">Yes</button>
                        <button class="btn btn-danger" onclick="confirmRestart(false)">No</button>
                    </div>
                </div>
            </div>

            <!-- Final Boss Preparation Modal -->
            <div id="final-boss-prep-modal" class="hidden modal-overlay">
                <div class="modal-content">
                    <h2 class="section-title text-red-500">The Final Challenge Awaits!</h2>
                    <p class="text-lg mb-4">You feel an immense evil presence. The Abyssal Horror is near! Prepare yourself, hero.</p>
                    <p class="text-md mb-4">Would you like to visit the shop one last time, or face your destiny?</p>
                    <div class="flex justify-center gap-4 mt-4">
                        <button class="btn btn-success" onclick="goToShopFromFinalBossPrep()">Visit Shop</button>
                        <button class="btn btn-danger" onclick="startFinalBossBattle()">Face the Horror!</button>
                    </div>
                </div>
            </div>

            <!-- Battle Result Modal -->
            <div id="battle-result-modal" class="hidden modal-overlay">
                <div class="modal-content">
                    <button class="modal-close-btn" onclick="closeBattleResult()">&times;</button>
                    <h2 class="section-title" id="result-title">Battle Won!</h2>
                    <p class="text-lg mb-2" id="result-xp"></p>
                    <p class="text-lg mb-2" id="result-coins"></p>
                    <p class="text-lg mb-4" id="result-equipment"></p>
                    <button class="btn btn-primary w-full" onclick="closeBattleResult()">Continue</button>
                </div>
            </div>

            <!-- Game Over/Victory Modal -->
            <div id="game-over-modal" class="hidden modal-overlay">
                <div class="modal-content">
                    <h2 class="section-title" id="game-over-title">Game Over!</h2>
                    <p class="text-lg mb-4" id="game-over-message"></p>
                    <p class="text-sm text-gray-400 mt-4">A grand adventure by Louis LAN. Made with passion in New Zealand. 2025.</p>
                    <button class="btn btn-primary w-full mt-4" onclick="restartGame()">Begin a New Journey</button>
                </div>
            </div>

            <!-- Restart Button (now visible) -->
            <button class="btn btn-primary w-full" id="restart-btn" onclick="showRestartConfirmation()">
                Restart Game
            </button>
        </div>
    </div>

    <script>
        // Player occupation base stats and skills
        const occupations = {
            Warrior: {
                maxHp: 100, attack: 9, defense: 12, critChance: 0.10,
                skills: {
                    1: { name: "Shield Bash", icon: "üõ°Ô∏è", effect: (target) => {
                        setMessage("You use Shield Bash! Stuns the enemy for 1 turn and deals moderate damage!");
                        const damage = Math.max(1, (player.attack + getTotalAttackBonus()) * 1.2 - target.defense); // Further reduced damage
                        target.hp -= damage;
                        target.stunned = true; // Stun for 1 turn
                        return damage;
                    }},
                    2: { name: "Heroic Strike", icon: "üí•", effect: (target) => {
                        setMessage("You use Heroic Strike! Deals heavy damage!");
                        const damage = Math.max(1, (player.attack + getTotalAttackBonus()) * 2.0 - target.defense); // Further reduced damage
                        target.hp -= damage;
                        return damage;
                    }}
                }
            },
            Mage: {
                maxHp: 70, attack: 10, defense: 5, critChance: 0.07,
                skills: {
                    1: { name: "Fireball", icon: "üî•", effect: (target) => {
                        setMessage("You cast Fireball! Deals massive magic damage!");
                        const damage = Math.max(1, (player.attack + getTotalAttackBonus()) * 1.8 - target.defense); // Further reduced damage
                        target.hp -= damage;
                        return damage;
                    }},
                    2: { name: "Blizzard", icon: "‚ùÑÔ∏è", effect: (target) => {
                        setMessage("You cast Blizzard! Deals heavy damage and slows enemy!");
                        const damage = Math.max(1, (player.attack + getTotalAttackBonus()) * 1.5 - target.defense); // Further reduced damage
                        target.hp -= damage;
                        target.slowed = true; // Slow for 1 turn
                        return damage;
                    }}
                }
            },
            Rogue: {
                maxHp: 95, attack: 10, defense: 10, critChance: 0.15,
                skills: {
                    1: { name: "Flurry of Blows", icon: "üí®", effect: (target) => {
                        let totalDamage = 0;
                        let hits = 0;
                        setMessage("You unleash a Flurry of Blows!");
                        for (let i = 0; i < 3; i++) {
                            if (Math.random() < 0.8) { // Increased hit chance for skill
                                const damage = Math.max(1, (player.attack + getTotalAttackBonus()) * 1.0 - target.defense); // Further reduced per-hit damage
                                target.hp -= damage;
                                totalDamage += damage;
                                hits++;
                            }
                        }
                        if (hits > 0) {
                            setMessage(`You hit ${hits} times for a total of ${totalDamage} damage!`);
                        } else {
                            setMessage("Your flurry missed!");
                        }
                        return totalDamage;
                    }},
                    2: { name: "Backstab", icon: "üî™", effect: (target) => {
                        setMessage("You use Backstab! Deals critical damage!");
                        const damage = Math.max(1, (player.attack + getTotalAttackBonus()) * 3.0 - target.defense); // Further reduced damage
                        target.hp -= damage;
                        return damage;
                    }}
                }
            }
        };

        // Enemy definitions (with icons)
        // Tier 1 Enemies (Levels 1-2)
        const tier1Enemies = [
            { name: "Goblin", icon: "üëπ", hp: 45, attack: 12, defense: 6, xp: 35, coinDrop: [10, 15] },
            { name: "Slime", icon: "ü¶†", hp: 40, attack: 9, defense: 4, xp: 30, coinDrop: [8, 12] },
            { name: "Dire Wolf", icon: "üê∫", hp: 55, attack: 14, defense: 8, xp: 45, coinDrop: [12, 18] },
            { name: "Bandit", icon: "ü¶π‚Äç‚ôÇÔ∏è", hp: 50, attack: 13, defense: 7, xp: 40, coinDrop: [11, 16] },
        ];

        // Tier 2 Enemies (Levels 3-4) - Stronger versions
        const tier2Enemies = [
            { name: "Orc Grunt", icon: "üë∫", hp: 70, attack: 17, defense: 10, xp: 60, coinDrop: [15, 25] },
            { name: "Giant Spider", icon: "üï∑Ô∏è", hp: 65, attack: 16, defense: 9, xp: 55, coinDrop: [14, 22] },
            { name: "Stone Golem", icon: "ü™®", hp: 80, attack: 15, defense: 12, xp: 70, coinDrop: [18, 28] },
            { name: "Dark Cultist", icon: "üë§", hp: 60, attack: 20, defense: 8, xp: 65, coinDrop: [16, 26] }
        ];

        // Tier 3 Enemies (Levels 5+) - Even stronger
        const tier3Enemies = [
            { name: "Minotaur Warrior", icon: "üêÇ", hp: 100, attack: 22, defense: 14, xp: 90, coinDrop: [25, 40] },
            { name: "Shadow Beast", icon: "üêæ", hp: 90, attack: 25, defense: 10, xp: 85, coinDrop: [22, 38] },
            { name: "Ancient Treant", icon: "üå≥", hp: 110, attack: 20, defense: 16, xp: 95, coinDrop: [28, 45] }
        ];

        // New Monsters with Special Abilities
        const specialAbilityMonsters = [
            { name: "Regenerating Ogre", icon: "üíö", hp: 90, attack: 18, defense: 10, xp: 75, coinDrop: [20, 30], ability: "selfHeal", abilityRate: 0.15 }, // 15% chance to heal 10% of max HP
            { name: "Shadow Weaver", icon: "üåë", hp: 70, attack: 20, defense: 8, xp: 80, coinDrop: [20, 35], ability: "debuff", abilityRate: 0.20 }, // 20% chance to debuff player attack by 50% for 2 turns
            { name: "Ironclad Guardian", icon: "üõ°Ô∏è", hp: 120, attack: 15, defense: 18, xp: 100, coinDrop: [30, 45], ability: "shield", abilityRate: 0.10 } // 10% chance to activate 80% damage reduction shield for 2 turns
        ];


        const eliteEnemies = [
            // Stats adjusted to be tough but beatable for a Lv5 player
            { name: "Minotaur Lord", icon: "üêÇ", hp: 250, attack: 28, defense: 15, xp: 300, coinDrop: [80, 150] },
            { name: "Ancient Golem", icon: "üóø", hp: 300, attack: 25, defense: 20, xp: 350, coinDrop: [90, 180] },
            { name: "Shadow King", icon: "üë§", hp: 200, attack: 35, defense: 12, xp: 320, coinDrop: [100, 200] }
        ];

        // Final Boss (Level 6)
        const finalBoss = {
            name: "The Abyssal Horror", icon: "üêô", hp: 500, attack: 40, defense: 25, xp: 1000, coinDrop: [200, 500],
            isFinalBoss: true,
            immunityTurns: 0,
            strengthTurns: 0
        };

        // Shop Items (Full pool for randomization) - Equipment values reduced
        const fullShopItemPool = [
            { name: "Iron Sword", cost: 20, type: "weapon", attack: 3, defense: 0, icon: "üó°Ô∏è", description: "Attack +3", sellValue: 10, isEpic: false },
            { name: "Leather Armour", cost: 20, type: "armour", attack: 0, defense: 3, icon: "üõ°Ô∏è", description: "Defence +3", sellValue: 10, isEpic: false },
            { name: "Healing Potion", cost: 15, type: "heal", value: 50, icon: "üß™", description: "Restores 50 HP", sellValue: 7, isEpic: false },
            { name: "Steel Broadsword", cost: 40, type: "weapon", attack: 5, defense: 0, icon: "‚öîÔ∏è", description: "Attack +5", sellValue: 20, isEpic: false },
            { name: "Chainmail Vest", cost: 40, type: "armour", attack: 0, defense: 5, icon: "ü™ñ", description: "Defence +5", sellValue: 20, isEpic: false },
            { name: "Amulet of Haste", cost: 50, type: "accessory", attack: 2, defense: 2, icon: "‚ö°", description: "Attack +2, Defence +2", sellValue: 25, isEpic: false },
            { name: "Ring of Resilience", cost: 60, type: "accessory", attack: 3, defense: 3, icon: "üíç", description: "Attack +3, Defence +3", sellValue: 30, isEpic: false },
            // Epic Items - Only purchasable in shop
            { name: "Dragon Blade", cost: 300, type: "weapon", attack: 10, defense: 0, icon: "üêâ", description: "Attack +10 (Epic)", sellValue: 150, isEpic: true },
            { name: "Aegis Shield", cost: 300, type: "armour", attack: 0, defense: 10, icon: "‚ú®", description: "Defence +10 (Epic)", sellValue: 150, isEpic: true },
            { name: "Phoenix Amulet", cost: 200, type: "accessory", attack: 8, defense: 8, icon: "üî•", description: "Attack +8, Defence +8 (Epic)", sellValue: 100, isEpic: true }
        ];

        // Companion types
        const companions = {
            Healer: {
                name: "Healer", icon: "‚öïÔ∏è", cost: 50,
                description: "Heals you for 10 HP every 10 turns.",
                effect: () => {
                    const healAmount = 10;
                    player.hp = Math.min(player.maxHp, Math.floor(player.hp + healAmount)); // Ensure integer HP
                    setMessage(gameMessage.textContent + ` Your Healer companion heals you for ${healAmount} HP!`);
                    companionHealSound.triggerAttackRelease("G4", "8n", Tone.now());
                },
                frequency: 10 // Every 10 turns
            },
            DarkSlave: {
                name: "Dark Slave", icon: "üòà", cost: 60,
                description: "Deals 10 damage to the enemy every 5 turns.",
                effect: (target) => {
                    const damage = 10;
                    target.hp -= damage;
                    target.hp = Math.floor(target.hp); // Ensure integer HP
                    setMessage(gameMessage.textContent + ` Your Dark Slave companion attacks for ${damage} damage!`);
                    companionAttackSound.triggerAttackRelease("C3", "8n", Tone.now());
                },
                frequency: 5 // Every 5 turns
            },
            Pet: {
                name: "Pet", icon: "üêæ", cost: 40,
                description: "Deals 5 damage and heals you for 5 HP every 8 turns.", // Changed frequency to 8
                effect: (target) => {
                    const damage = 5;
                    const healAmount = 5;
                    target.hp -= damage;
                    target.hp = Math.floor(target.hp); // Ensure integer HP
                    player.hp = Math.min(player.maxHp, Math.floor(player.hp + healAmount)); // Ensure integer HP
                    setMessage(gameMessage.textContent + ` Your Pet companion attacks for ${damage} damage and heals you for ${healAmount} HP!`);
                    companionAttackSound.triggerAttackRelease("E4", "8n", Tone.now());
                    companionHealSound.triggerAttackRelease("C5", "8n", Tone.now());
                },
                frequency: 8 // Every 8 turns
            }
        };

        // XP required for each level
        const xpRequirements = {
            1: 100, // To reach Level 2 (approx 3 regular monsters)
            2: 250, // To reach Level 3 (approx 5 regular monsters from Lv2)
            3: 450, // To reach Level 4 (approx 7 regular monsters from Lv3)
            4: 700, // To reach Level 5
            5: 850, // Adjusted to make Lv 5 to Lv 6 more achievable
            6: 999999 // Max level, no more leveling up
        };


        // Tone.js Sound Effects Setup
        let attackSound, levelUpSound, victorySound, defeatSound, coinSound, itemSound, skillSound, potionSound, companionHealSound, companionAttackSound, criticalHitSound, debuffSound, shieldSound, healMonsterSound;

        // Game UI Elements (Declared as let, assigned in window.onload)
        let gameContainer, occupationScreen, gameScreen, gameMessage, playerOccupation, playerLevel, playerAttack, playerDefense, playerHpText, playerHpBar, playerXpText, playerXpBar, playerCoins, playerPotions, playerEquipment, companionDisplay, playerStatsDisplay, potionCountMainMenu, usePotionOutOfBattleBtn;
        let enemyDisplay, enemyIcon, enemyName, enemyAttack, enemyDefense, enemyHpText, enemyHpBar;
        let mainMenuActions, battleActions, exploreBtn, attackBtn, skillBtn, skillIcon, skillName, potionBtn, potionCount, fleeBtn, restartBtn;
        let confirmModal, finalBossPrepModal, battleResultModal, resultTitle, resultXp, resultCoins, resultEquipment, gameOverModal, gameOverTitle, gameOverMessage;
        let shopScreen, shopItemsContainer, equippedItemsSellContainer; // Added shop and hire screen elements
        let hireScreen, hireOptionsContainer;


        window.onload = () => {
            // Assign UI elements here to ensure DOM is loaded
            gameContainer = document.getElementById('game-container');
            occupationScreen = document.getElementById('occupation-screen');
            gameScreen = document.getElementById('game-screen');
            gameMessage = document.getElementById('game-message');
            playerOccupation = document.getElementById('player-occupation');
            playerLevel = document.getElementById('player-level');
            playerAttack = document.getElementById('player-attack');
            playerDefense = document.getElementById('player-defence');
            playerHpText = document.getElementById('player-hp-text');
            playerHpBar = document.getElementById('player-hp-bar');
            playerXpText = document.getElementById('player-xp-text');
            playerXpBar = document.getElementById('player-xp-bar');
            playerCoins = document.getElementById('player-coins');
            playerPotions = document.getElementById('player-potions');
            playerEquipment = document.getElementById('player-equipment');
            companionDisplay = document.getElementById('companion-display');
            playerStatsDisplay = document.getElementById('player-stats-display');
            potionCountMainMenu = document.getElementById('potion-count-main-menu');
            usePotionOutOfBattleBtn = document.getElementById('use-potion-out-of-battle-btn');

            enemyDisplay = document.getElementById('enemy-display');
            enemyIcon = document.getElementById('enemy-icon');
            enemyName = document.getElementById('enemy-name');
            enemyAttack = document.getElementById('enemy-attack');
            enemyDefense = document.getElementById('enemy-defence');
            enemyHpText = document.getElementById('enemy-hp-text');
            enemyHpBar = document.getElementById('enemy-hp-bar');

            mainMenuActions = document.getElementById('main-menu-actions');
            battleActions = document.getElementById('battle-actions');
            exploreBtn = document.getElementById('explore-btn');
            attackBtn = document.getElementById('attack-btn');
            skillBtn = document.getElementById('skill-btn');
            skillIcon = document.getElementById('skill-icon');
            skillName = document.getElementById('skill-name');
            potionBtn = document.getElementById('potion-btn');
            potionCount = document.getElementById('potion-count');
            fleeBtn = document.getElementById('flee-btn');
            restartBtn = document.getElementById('restart-btn');

            confirmModal = document.getElementById('confirm-modal');
            finalBossPrepModal = document.getElementById('final-boss-prep-modal');
            battleResultModal = document.getElementById('battle-result-modal');
            resultTitle = document.getElementById('result-title');
            resultXp = document.getElementById('result-xp');
            resultCoins = document.getElementById('result-coins');
            resultEquipment = document.getElementById('result-equipment');
            gameOverModal = document.getElementById('game-over-modal');
            gameOverTitle = document.getElementById('game-over-title');
            gameOverMessage = document.getElementById('game-over-message');

            // Assign shop and hire screen elements
            shopScreen = document.getElementById('shop-screen');
            shopItemsContainer = document.getElementById('shop-items-container');
            equippedItemsSellContainer = document.getElementById('equipped-items-sell-container');
            hireScreen = document.getElementById('hire-screen');
            hireOptionsContainer = document.getElementById('hire-options-container');


            // Start audio context on first user interaction
            document.body.addEventListener('click', () => {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
            }, { once: true });

            // Attack Sound (short, sharp, quieter)
            attackSound = new Tone.MembraneSynth({
                volume: -20, // Quieter
                pitchDecay: 0.05,
                octaves: 8,
                oscillator: { type: "square" },
                envelope: {
                    attack: 0.001,
                    decay: 0.4,
                    sustain: 0.01,
                    release: 0.8,
                    attackCurve: "exponential"
                }
            }).toDestination();

            // Level Up Sound (ascending chime, quieter)
            levelUpSound = new Tone.PolySynth(Tone.Synth, {
                volume: -15, // Quieter
                oscillator: { type: "triangle" },
                envelope: {
                    attack: 0.05,
                    decay: 0.3,
                    sustain: 0.0,
                    release: 0.5
                }
            }).toDestination();

            // Victory Sound (triumphant fanfare, quieter)
            victorySound = new Tone.PolySynth(Tone.Synth, {
                volume: -15, // Quieter
                oscillator: { type: "sawtooth" },
                envelope: {
                    attack: 0.1,
                    decay: 0.5,
                    sustain: 0.1,
                    release: 1
                }
            }).toDestination();

            // Defeat Sound (descending, somber, quieter)
            defeatSound = new Tone.PolySynth(Tone.Synth, {
                volume: -15, // Quieter
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.1,
                    decay: 0.5,
                    sustain: 0.1,
                    release: 1
                }
            }).toDestination();

            // Coin Picked Sound (short, high chime)
            coinSound = new Tone.PolySynth(Tone.Synth, {
                volume: -20, // Quieter
                oscillator: { type: "square" },
                envelope: {
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.0,
                    release: 0.2
                }
            }).toDestination();

            // Item Picked Sound (slightly longer, pleasant chime)
            itemSound = new Tone.PolySynth(Tone.Synth, {
                volume: -17, // Quieter
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.02,
                    decay: 0.2,
                    sustain: 0.0,
                    release: 0.4
                }
            }).toDestination();

            // Skill Use Sound (distinct based on skill type, for now a generic magic sound)
            skillSound = new Tone.PolySynth(Tone.Synth, {
                volume: -15, // Quieter
                oscillator: { type: "fmsine", modulationIndex: 5 },
                envelope: {
                    attack: 0.01,
                    decay: 0.6,
                    sustain: 0.0,
                    release: 0.8
                }
            }).toDestination();

            // Potion Use Sound
            potionSound = new Tone.PolySynth(Tone.Synth, {
                volume: -15, // Quieter
                oscillator: { type: "triangle" },
                envelope: {
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.0,
                    release: 0.2
                }
            }).toDestination();

            // Companion Heal Sound
            companionHealSound = new Tone.PolySynth(Tone.Synth, {
                volume: -20, // Quieter
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.0,
                    release: 0.2
                }
            }).toDestination();

            // Companion Attack Sound
            companionAttackSound = new Tone.MembraneSynth({
                volume: -20, // Quieter
                pitchDecay: 0.02,
                octaves: 5,
                oscillator: { type: "square" },
                envelope: {
                    attack: 0.001,
                    decay: 0.2,
                    sustain: 0.01,
                    release: 0.5,
                }
            }).toDestination();

            // Critical Hit Sound (sharp, high impact)
            criticalHitSound = new Tone.Synth({
                volume: -10, // Louder for impact
                oscillator: { type: "square" },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.0,
                    release: 0.3
                }
            }).toDestination();

            // Debuff Sound (low, descending tone)
            debuffSound = new Tone.PolySynth(Tone.Synth, {
                volume: -15,
                oscillator: { type: "sawtooth" },
                envelope: {
                    attack: 0.05,
                    decay: 0.4,
                    sustain: 0.0,
                    release: 0.6
                }
            }).toDestination();

            // Shield Activate Sound (ascending, metallic)
            shieldSound = new Tone.PolySynth(Tone.Synth, {
                volume: -15,
                oscillator: { type: "triangle" },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.0,
                    release: 0.3
                }
            }).toDestination();

            // Monster Heal Sound
            healMonsterSound = new Tone.PolySynth(Tone.Synth, {
                volume: -18,
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.02,
                    decay: 0.1,
                    sustain: 0.0,
                    release: 0.2
                }
            }).toDestination();
        };

        // Game State Variables
        let player = {};
        const MAX_EQUIPPED_ITEMS = 5; // Max number of equipped items
        let currentEnemy = null;
        const FROM_HELL_BATTLE_FREQUENCY = 5; // Every 5 battles, encounter a "from Hell" monster
        const MIN_LEVEL_FOR_ELITE = 5; // Minimum level to start encountering elite monsters
        let skillCooldown = 0; // Cooldown for player skill (turns)
        const SKILL_COOLDOWN_TURNS = 7; // Turns needed to reset skill cooldown (increased from 5)
        let battleRewards = { xp: 0, coins: 0, equipment: [] }; // To store rewards for the result window (array for equipment)
        let playerDebuffTurns = 0; // Tracks turns for player debuff
        let enemyShieldTurns = 0; // Tracks turns for enemy shield
        let enemyImmunityTurns = 0; // Tracks turns for enemy immunity
        let enemyStrengthTurns = 0; // Tracks turns for enemy strength (attack/defence)

        /**
         * Calculates total attack bonus from equipped items.
         */
        function getTotalAttackBonus() {
            return player.equippedItems.reduce((sum, item) => sum + (item.attack || 0), 0);
        }

        /**
         * Calculates total defence bonus from equipped items.
         */
        function getTotalDefenseBonus() {
            return player.equippedItems.reduce((sum, item) => sum + (item.defense || 0), 0);
        }

        /**
         * Updates the player's stats display on the UI.
         */
        function updatePlayerStats() {
            playerOccupation.textContent = player.occupation;
            playerLevel.textContent = player.level;
            playerAttack.textContent = player.attack + getTotalAttackBonus();
            playerDefense.textContent = player.defense + getTotalDefenseBonus();
            playerCoins.textContent = player.coins;
            playerPotions.textContent = player.potions;
            potionCountMainMenu.textContent = player.potions; // Update potion count on main menu button

            // Disable potion button if no potions or full HP
            usePotionOutOfBattleBtn.disabled = player.potions <= 0 || player.hp >= player.maxHp;
            usePotionOutOfBattleBtn.classList.toggle('opacity-50', player.potions <= 0 || player.hp >= player.maxHp);


            // Display all equipped items with their effects
            if (player.equippedItems.length > 0) {
                playerEquipment.innerHTML = player.equippedItems.map(item => {
                    let effect = [];
                    if (item.attack > 0) effect.push(`Atk +${item.attack}`);
                    if (item.defense > 0) effect.push(`Def +${item.defense}`);
                    return `${item.name} (${item.icon}) (${effect.join(', ')})`;
                }).join('<br>');
            } else {
                playerEquipment.textContent = "None";
            }

            // Display companion
            companionDisplay.textContent = player.companion ? `Companion: ${player.companion.name} ${player.companion.icon}` : "Companion: None";

            playerHpText.textContent = `${player.hp}/${player.maxHp}`;
            playerHpBar.style.width = `${(player.hp / player.maxHp) * 100}%`;

            // Update HP bar color based on percentage
            playerHpBar.classList.remove('green-hp', 'yellow-hp', 'red-hp');
            const playerHpPercentage = (player.hp / player.maxHp) * 100;
            if (playerHpPercentage > 50) {
                playerHpBar.classList.add('green-hp');
            } else if (playerHpPercentage > 20) {
                playerHpBar.classList.add('yellow-hp');
            } else {
                playerHpBar.classList.add('red-hp');
            }


            playerXpText.textContent = `${player.xp}/${player.xpToNextLevel}`;
            playerXpBar.style.width = `${(player.xp / player.xpToNextLevel) * 100}%`;

            // Update skill button state based on skillCooldown
            if (player.skillName) {
                skillName.textContent = player.skillName;
                skillIcon.textContent = player.skillIcon;
                skillBtn.disabled = skillCooldown > 0;
                skillBtn.classList.toggle('opacity-50', skillCooldown > 0);
                skillBtn.title = skillCooldown > 0 ? `Cooldown: ${skillCooldown} turns` : 'Skill Ready!';
            }

            // Update potion button state
            potionBtn.disabled = player.potions <= 0;
            potionBtn.classList.toggle('opacity-50', player.potions <= 0);
            potionCount.textContent = player.potions;

            // Apply/remove debuff visual
            if (playerDebuffTurns > 0) {
                playerStatsDisplay.classList.add('debuff-active');
            } else {
                playerStatsDisplay.classList.remove('debuff-active');
            }
        }

        /**
         * Updates the enemy's stats display on the UI.
         */
        function updateEnemyStats() {
            enemyIcon.textContent = currentEnemy.icon;
            let enemyDisplayName = currentEnemy.name;
            if (currentEnemy.isFromHell) { // Check for "from Hell" property
                enemyDisplayName += " (from Hell)";
            } else if (eliteEnemies.some(e => e.name === currentEnemy.name)) {
                enemyDisplayName += " (Elite)";
            } else if (currentEnemy.isFinalBoss) {
                enemyDisplayName += " (Final Boss)";
            }
            enemyName.textContent = enemyDisplayName;
            enemyAttack.textContent = currentEnemy.attack;
            enemyDefense.textContent = currentEnemy.defense;
            // Ensure enemy HP is not negative for display
            const displayHp = Math.max(0, Math.floor(currentEnemy.hp)); // Ensure integer HP
            enemyHpText.textContent = `${displayHp}/${currentEnemy.maxHp}`;
            enemyHpBar.style.width = `${(displayHp / currentEnemy.maxHp) * 100}%`;

            // Update HP bar color based on percentage
            enemyHpBar.classList.remove('green-hp', 'yellow-hp', 'red-hp');
            const enemyHpPercentage = (currentEnemy.hp / currentEnemy.maxHp) * 100;
            if (enemyHpPercentage > 50) {
                enemyHpBar.classList.add('green-hp');
            } else if (enemyHpPercentage > 20) {
                enemyHpBar.classList.add('yellow-hp');
            } else {
                enemyHpBar.classList.add('red-hp');
            }

            // Apply/remove shield/immunity visual
            if (enemyShieldTurns > 0) {
                enemyDisplay.classList.add('shield-active');
            } else {
                enemyDisplay.classList.remove('shield-active');
            }
            if (enemyImmunityTurns > 0) {
                enemyDisplay.classList.add('immunity-active');
            } else {
                enemyDisplay.classList.remove('immunity-active');
            }
        }

        /**
         * Sets the game message.
         * @param {string} message - The message to display.
         */
        function setMessage(message) {
            gameMessage.textContent = message;
            gameMessage.classList.add('slide-in'); // Add slide-in animation
            setTimeout(() => gameMessage.classList.remove('slide-in'), 500);
        }

        /**
         * Selects the player's occupation and starts the game.
         * @param {string} occupationName - The chosen occupation.
         */
        function selectOccupation(occupationName) {
            const baseStats = occupations[occupationName];
            player = {
                occupation: occupationName,
                level: 1,
                xp: 0,
                xpToNextLevel: xpRequirements[1],
                hp: baseStats.maxHp,
                maxHp: baseStats.maxHp,
                attack: baseStats.attack,
                defense: baseStats.defense,
                critChance: baseStats.critChance,
                coins: 0,
                potions: 1, // Start with one potion
                equippedItems: [], // Array for multiple equipment
                skillName: baseStats.skills[1].name,
                skillIcon: baseStats.skills[1].icon,
                skillEffect: baseStats.skills[1].effect,
                skillCooldown: 0, // Skill ready at start of battle
                maxSkillCooldown: SKILL_COOLDOWN_TURNS,
                companion: null, // Single companion
                companionTurnCounter: 0, // Reset companion turn counter
                encountersFought: 0, // Initialize encountersFought here
                battlesSinceLastFromHell: 0, // Initialize battlesSinceLastFromHell here
                hasFoughtFinalBoss: false // New flag for final boss
            };

            occupationScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            setMessage(`Welcome, ${player.occupation}! Your adventure begins.`);
            updatePlayerStats();
            showMainMenu(); // Show main menu after occupation selection
            restartBtn.classList.remove('hidden'); // Show restart button
        }

        /**
         * Shows the main menu actions.
         */
        function showMainMenu() {
            mainMenuActions.classList.remove('hidden');
            battleActions.classList.add('hidden');
            enemyDisplay.classList.add('hidden');
            shopScreen.classList.add('hidden');
            hireScreen.classList.add('hidden');
            finalBossPrepModal.classList.add('hidden'); // Hide final boss prep modal if visible
            setMessage("What will you do next?");
            skillCooldown = 0; // Reset skill cooldown when returning to main menu
            updatePlayerStats(); // Update skill button state
            restartBtn.classList.remove('hidden'); // Ensure restart button is visible
        }

        /**
         * Generates a random enemy for an encounter based on player level.
         * @returns {object} The generated enemy.
         */
        function generateEnemy() {
            let enemyPool;
            // Adjust monster difficulty at Lv3+
            let defenseMultiplier = 1 + (player.level - 1) * 0.01; // Reduced from 0.02

            if (player.level <= 2) {
                enemyPool = tier1Enemies;
            } else if (player.level <= 4) {
                enemyPool = tier2Enemies;
            } else { // Level 5+
                enemyPool = tier3Enemies;
            }

            // Add special ability monsters to the pool based on player level
            if (player.level >= 3) {
                enemyPool = [...enemyPool, ...specialAbilityMonsters];
            }

            const baseEnemy = enemyPool[Math.floor(Math.random() * enemyPool.length)];
            let levelMultiplier = 1 + (player.level - 1) * 0.25; // Enemies scale more with player level
            let isFromHell = false;

            // Check for "from Hell" monster
            if (player.battlesSinceLastFromHell >= FROM_HELL_BATTLE_FREQUENCY) {
                levelMultiplier *= 1.2; // 20% stronger
                isFromHell = true;
                player.battlesSinceLastFromHell = 0; // Reset counter
            }

            const newEnemy = {
                name: baseEnemy.name,
                icon: baseEnemy.icon,
                hp: Math.floor(baseEnemy.hp * levelMultiplier),
                maxHp: Math.floor(baseEnemy.hp * levelMultiplier), // Ensure maxHp is set
                attack: Math.floor(baseEnemy.attack * levelMultiplier),
                // Increase monster's defence based on player's level (adjusted scaling)
                defense: Math.floor(baseEnemy.defense * levelMultiplier * defenseMultiplier),
                xp: baseEnemy.xp,
                coinDrop: baseEnemy.coinDrop,
                critChance: 0.05, // Monster critical hit chance
                stunned: false,
                slowed: false, // For mage skill
                isFromHell: isFromHell,
                ability: baseEnemy.ability || null, // Special ability
                abilityRate: baseEnemy.abilityRate || 0, // Rate of ability activation
                shieldActive: false,
                shieldTurns: 0,
                debuffTurns: 0, // For debuff monster
                immunityTurns: 0, // For final boss
                strengthTurns: 0 // For final boss
            };

            return newEnemy;
        }

        /**
         * Initiates an exploration phase, leading to an an encounter.
         */
        function explore() {
            if (player.hp <= 0) {
                setMessage("You are defeated! Restart the game.");
                return;
            }

            // Hide main menu actions
            mainMenuActions.classList.add('hidden');
            battleActions.classList.remove('hidden');

            // Reset skill cooldown at start of battle
            skillCooldown = 0;

            // Final Boss logic (Lv 6)
            if (player.level === 6 && !player.hasFoughtFinalBoss) {
                finalBossPrepModal.classList.remove('hidden');
                setMessage("The Final Challenge Awaits!");
                return; // Stop here, wait for player choice
            }

            // Elite Battle logic (Lv 5) - higher chance, no choice
            if (player.level === 5 && Math.random() < 0.4) { // 40% chance for elite at Lv 5
                currentEnemy = { ...eliteEnemies[Math.floor(Math.random() * eliteEnemies.length)] };
                currentEnemy.maxHp = currentEnemy.hp;
                currentEnemy.shieldActive = false;
                currentEnemy.shieldTurns = 0;
                currentEnemy.debuffTurns = 0;
                currentEnemy.immunityTurns = 0;
                currentEnemy.strengthTurns = 0;
                setMessage(`A powerful ${currentEnemy.name} (Elite) appears! Prepare for a tough battle!`);
            } else {
                // Regular monster generation
                currentEnemy = generateEnemy();
                setMessage(`You encountered a ${currentEnemy.name}!`);
            }
            enemyDisplay.classList.remove('hidden');
            updateEnemyStats();
            updatePlayerStats(); // Update skill button state
        }

        /**
         * Handles the choice to go to shop from final boss prep.
         */
        function goToShopFromFinalBossPrep() {
            finalBossPrepModal.classList.add('hidden');
            showShop();
        }

        /**
         * Starts the final boss battle.
         */
        function startFinalBossBattle() {
            finalBossPrepModal.classList.add('hidden');
            currentEnemy = { ...finalBoss }; // Use a copy to avoid modifying the original
            currentEnemy.maxHp = currentEnemy.hp;
            currentEnemy.shieldActive = false;
            currentEnemy.shieldTurns = 0;
            currentEnemy.debuffTurns = 0;
            currentEnemy.immunityTurns = 0;
            currentEnemy.strengthTurns = 0;
            setMessage(`You face THE ABYSSAL HORROR! This is it, hero!`);
            enemyDisplay.classList.remove('hidden');
            battleActions.classList.remove('hidden');
            updateEnemyStats();
            updatePlayerStats();
        }


        /**
         * Handles the player's attack turn.
         */
        function attack() {
            if (!currentEnemy || player.hp <= 0) return;

            attackSound.triggerAttackRelease("C4", "8n", Tone.now()); // Play attack sound
            enemyDisplay.classList.add('flash'); // Flash enemy on hit
            setTimeout(() => enemyDisplay.classList.remove('flash'), 200);

            let effectivePlayerAttack = player.attack + getTotalAttackBonus();
            if (playerDebuffTurns > 0) {
                effectivePlayerAttack = Math.floor(effectivePlayerAttack / 2); // Half attack if debuffed
            }

            let playerDamage = Math.max(1, effectivePlayerAttack - currentEnemy.defense);

            // Ensure a minimum amount of damage is dealt (adjusted for higher levels)
            playerDamage = Math.max(playerDamage, Math.floor(effectivePlayerAttack * 0.2)); // At least 20% of player's attack as damage

            // Apply damage reduction if shield is active
            if (currentEnemy.shieldActive) {
                playerDamage = Math.floor(playerDamage * 0.20); // Absorb 80% damage
                setMessage(`The ${currentEnemy.name}'s shield absorbs most of the damage!`);
            }

            let isCritical = false;
            if (Math.random() < player.critChance) {
                playerDamage = Math.floor(playerDamage * 1.5); // 1.5x critical damage
                isCritical = true;
                criticalHitSound.triggerAttackRelease("D5", "8n", Tone.now());
                gameContainer.classList.add('shake');
                setTimeout(() => gameContainer.classList.remove('shake'), 300);
            }

            // Rogue's multi-hit chance (only for basic attack) - up to 5 hits
            if (player.occupation === 'Rogue' && !isCritical) {
                let hits = 1;
                const rand = Math.random();
                if (rand < 0.01) { // 1% chance for 5 hits
                    hits = 5;
                } else if (rand < 0.03) { // 2% chance for 4 hits (0.01 to 0.03)
                    hits = 4;
                } else if (rand < 0.10) { // 7% chance for 3 hits (0.03 to 0.10)
                    hits = 3;
                } else if (rand < 0.30) { // 20% chance for 2 hits (0.10 to 0.30)
                    hits = 2;
                } // 70% chance for 1 hit (0.30 to 1.0)
                playerDamage *= hits;
                setMessage(`You hit the ${currentEnemy.name} for ${playerDamage} damage! (${hits} hits!)`);
            } else if (isCritical) {
                setMessage(`üí• Critical Hit! You hit the ${currentEnemy.name} for ${playerDamage} damage!`);
            } else {
                setMessage(`You hit the ${currentEnemy.name} for ${playerDamage} damage!`);
            }

            currentEnemy.hp -= playerDamage;
            currentEnemy.hp = Math.floor(currentEnemy.hp); // Ensure integer HP
            updateEnemyStats();

            if (currentEnemy.hp <= 0) {
                currentEnemy.hp = 0; // Ensure HP is 0 in UI
                updateEnemyStats();
                setMessage(`You defeated the ${currentEnemy.name}!`);
                handleEnemyDefeated();
                return;
            }

            // Enemy's turn (after a short delay for better flow)
            setTimeout(() => {
                handleEnemyTurn();
            }, 1000); // 1 second delay for enemy attack
        }

        /**
         * Handles the player using their skill.
         */
        function useSkill() {
            if (!currentEnemy || player.hp <= 0 || skillCooldown > 0) return;

            skillSound.triggerAttackRelease(["C5", "E5", "G5"], "8n", Tone.now()); // Play skill sound
            enemyDisplay.classList.add('flash'); // Flash enemy on skill hit
            setTimeout(() => enemyDisplay.classList.remove('flash'), 200);

            if (currentEnemy.isFinalBoss && enemyImmunityTurns > 0) {
                setMessage(`The ${currentEnemy.name} is immune to your skill!`);
            } else {
                player.skillEffect(currentEnemy); // Execute skill effect
                currentEnemy.hp = Math.floor(currentEnemy.hp); // Ensure integer HP
            }
            updateEnemyStats();

            skillCooldown = SKILL_COOLDOWN_TURNS; // Set cooldown
            updatePlayerStats(); // Update skill button state

            if (currentEnemy.hp <= 0) {
                currentEnemy.hp = 0; // Ensure HP is 0 in UI
                updateEnemyStats();
                setMessage(`You defeated the ${currentEnemy.name} with your skill!`);
                handleEnemyDefeated();
                return;
            }

            // Enemy's turn (after a short delay for better flow)
            setTimeout(() => {
                handleEnemyTurn();
            }, 1500); // Slightly longer delay for skill animations/messages
        }

        /**
         * Handles using a potion during battle.
         */
        function usePotion() {
            if (player.potions <= 0 || player.hp <= 0) {
                setMessage("You have no potions left!");
                return;
            }

            potionSound.triggerAttackRelease("E5", "8n", Tone.now()); // Play potion sound
            player.potions--;
            const potionHeal = fullShopItemPool.find(item => item.name === "Healing Potion").value;
            player.hp = Math.min(player.maxHp, Math.floor(player.hp + potionHeal)); // Ensure integer HP
            setMessage(`You used a potion and healed ${potionHeal} HP!`);
            updatePlayerStats();

            // Enemy still attacks after potion use
            setTimeout(() => {
                handleEnemyTurn();
            }, 1000);
        }

        /**
         * Handles using a potion outside of battle.
         */
        function usePotionOutOfBattle() {
            if (player.potions <= 0) {
                setMessage("You have no potions left!");
                return;
            }
            if (player.hp >= player.maxHp) {
                setMessage("Your HP is already full!");
                return;
            }

            potionSound.triggerAttackRelease("E5", "8n", Tone.now());
            player.potions--;
            const potionHeal = fullShopItemPool.find(item => item.name === "Healing Potion").value;
            player.hp = Math.min(player.maxHp, Math.floor(player.hp + potionHeal));
            setMessage(`You used a potion and healed ${potionHeal} HP!`);
            updatePlayerStats();
        }

        /**
         * Handles the enemy's turn, including special abilities.
         */
        function handleEnemyTurn() {
            if (player.hp <= 0) return; // Player already defeated

            // Decrease debuff/shield/immunity/strength turns
            if (playerDebuffTurns > 0) {
                playerDebuffTurns--;
                if (playerDebuffTurns === 0) {
                    setMessage("Your attack returns to normal!");
                }
            }
            if (enemyShieldTurns > 0) {
                enemyShieldTurns--;
                if (enemyShieldTurns === 0) {
                    currentEnemy.shieldActive = false;
                    setMessage(`The ${currentEnemy.name}'s shield dissipates!`);
                }
            }
            if (enemyImmunityTurns > 0) {
                enemyImmunityTurns--;
                if (enemyImmunityTurns === 0) {
                    setMessage(`The ${currentEnemy.name}'s immunity wears off!`);
                }
            }
            if (enemyStrengthTurns > 0) {
                enemyStrengthTurns--;
                if (enemyStrengthTurns === 0) {
                    setMessage(`The ${currentEnemy.name}'s strength boost wears off!`);
                }
            }

            // Companion's turn (if any)
            if (player.companion) {
                player.companionTurnCounter++;
                if (player.companionTurnCounter % player.companion.frequency === 0) {
                    player.companion.effect(currentEnemy);
                    updateEnemyStats(); // Update enemy HP after companion attack
                }
                if (currentEnemy.hp <= 0) { // Check if companion finished off enemy
                    currentEnemy.hp = 0; // Ensure HP is 0 in UI
                    updateEnemyStats();
                    setMessage(`You defeated the ${currentEnemy.name}!`);
                    handleEnemyDefeated();
                    return;
                }
            }

            if (currentEnemy.stunned) {
                setMessage(`${currentEnemy.name} is stunned and cannot attack!`);
                currentEnemy.stunned = false; // Remove stun after one turn
                setMessage("Your turn. What will you do?");
                skillCooldown = Math.max(0, skillCooldown - 1); // Decrease skill cooldown
                updatePlayerStats(); // Update skill button state after turn
                updateEnemyStats(); // Update enemy status
                return; // Skip enemy attack
            }
            if (currentEnemy.slowed) { // Mage's Blizzard effect
                setMessage(`${currentEnemy.name} is slowed!`);
                currentEnemy.slowed = false; // Remove slow after one turn
            }

            // Enemy special abilities
            if (currentEnemy.ability && Math.random() < currentEnemy.abilityRate) {
                if (currentEnemy.ability === "selfHeal") {
                    const healAmount = Math.floor(currentEnemy.maxHp * 0.10); // Heal 10% of max HP
                    currentEnemy.hp = Math.min(currentEnemy.maxHp, currentEnemy.hp + healAmount);
                    healMonsterSound.triggerAttackRelease("G4", "8n", Tone.now());
                    setMessage(`${currentEnemy.name} healed itself for ${healAmount} HP!`);
                    enemyDisplay.classList.add('spin'); // Spin animation for healing
                    setTimeout(() => enemyDisplay.classList.remove('spin'), 500);
                } else if (currentEnemy.ability === "debuff") {
                    playerDebuffTurns = 2; // Debuff player attack for 2 turns
                    debuffSound.triggerAttackRelease("C3", "8n", Tone.now());
                    setMessage(`${currentEnemy.name} used Debuff! Your attack is halved for 2 turns!`);
                    playerStatsDisplay.classList.add('flash'); // Flash player stats on debuff
                    setTimeout(() => playerStatsDisplay.classList.remove('flash'), 200);
                } else if (currentEnemy.ability === "shield") {
                    enemyShieldTurns = 2; // Shield active for 2 turns
                    currentEnemy.shieldActive = true;
                    shieldSound.triggerAttackRelease(["C4", "E4", "G4"], "8n", Tone.now());
                    setMessage(`${currentEnemy.name} activated a damage reduction shield!`);
                }
            }

            // Final Boss special abilities
            if (currentEnemy.isFinalBoss) {
                if (currentEnemy.immunityTurns === 0 && Math.random() < 0.3) { // 30% chance for immunity
                    currentEnemy.immunityTurns = 2;
                    setMessage(`The ${currentEnemy.name} is now immune to skills for 2 turns!`);
                    enemyDisplay.classList.add('spin');
                    setTimeout(() => enemyDisplay.classList.remove('spin'), 500);
                }
                if (currentEnemy.strengthTurns === 0 && Math.random() < 0.4) { // 40% chance for strength buff
                    currentEnemy.strengthTurns = 2;
                    setMessage(`The ${currentEnemy.name} gains strength! Attack and Defence increased for 2 turns!`);
                    enemyDisplay.classList.add('flash');
                    setTimeout(() => enemyDisplay.classList.remove('flash'), 200);
                }
            }

            let effectivePlayerDefense = player.defense + getTotalDefenseBonus();
            let enemyAttackValue = currentEnemy.attack;

            if (currentEnemy.isFinalBoss && currentEnemy.strengthTurns > 0) {
                enemyAttackValue = Math.floor(enemyAttackValue * 1.5); // 50% increased attack for boss strength
            }

            let enemyDamage = Math.max(1, enemyAttackValue - effectivePlayerDefense);

            if (currentEnemy.isFinalBoss && currentEnemy.strengthTurns > 0) {
                // Boss defence is also increased for 2 turns with strength
                enemyDamage = Math.max(1, enemyAttackValue - Math.floor(effectivePlayerDefense * 1.5));
            }


            let enemyIsCritical = false;
            if (Math.random() < currentEnemy.critChance) {
                enemyDamage = Math.floor(enemyDamage * 1.5);
                enemyIsCritical = true;
                criticalHitSound.triggerAttackRelease("D3", "8n", Tone.now());
                gameContainer.classList.add('shake');
                setTimeout(() => gameContainer.classList.remove('shake'), 300);
            }

            let finalDamage = enemyDamage;
            let isTrueDamage = false;
            const trueDamageChance = 0.05; // 5% chance for true damage
            if (Math.random() < trueDamageChance) {
                const calculatedTrueDamage = effectivePlayerDefense; // True damage equals player's total defense
                if (calculatedTrueDamage > finalDamage) { // Only apply if true damage is greater than normal damage
                    finalDamage = calculatedTrueDamage;
                    isTrueDamage = true;
                }
            }

            player.hp -= finalDamage;
            player.hp = Math.floor(player.hp); // Ensure integer HP

            if (isTrueDamage) {
                setMessage(`üíÄ True Damage! ${currentEnemy.name} attacks you for ${finalDamage} damage, ignoring your defence!`);
            } else if (enemyIsCritical) {
                setMessage(`üí• Critical Hit! ${currentEnemy.name} attacks you for ${finalDamage} damage!`);
            } else {
                setMessage(`${currentEnemy.name} attacks you for ${finalDamage} damage!`);
            }
            updatePlayerStats();

            if (player.hp <= 0) {
                setMessage("You have been defeated! Game Over.");
                defeatSound.triggerAttackRelease(["C3", "A2", "F2"], "1n", Tone.now());
                endGame(false); // Player defeated
            }
            skillCooldown = Math.max(0, skillCooldown - 1); // Decrease skill cooldown
            updatePlayerStats(); // Update skill button state after turn
            updateEnemyStats(); // Update enemy status
        }


        /**
         * Handles the outcome when an enemy is defeated.
         */
        function handleEnemyDefeated() {
            // Increment battles since last "from Hell" monster
            player.battlesSinceLastFromHell++;

            // Collect rewards
            battleRewards.xp = currentEnemy.xp;
            const minCoins = currentEnemy.coinDrop[0];
            const maxCoins = currentEnemy.coinDrop[1];
            battleRewards.coins = Math.floor(Math.random() * (maxCoins - minCoins + 1)) + minCoins;
            battleRewards.equipment = []; // Reset for each battle

            player.xp += battleRewards.xp;
            player.coins += battleRewards.coins;

            // Equipment Drop (only non-epic items)
            const dropChance = eliteEnemies.some(e => e.name === currentEnemy.name) ? 0.7 : 0.3; // Increased drop chances
            if (Math.random() < dropChance) {
                const availableEquipmentDrops = fullShopItemPool.filter(item => !item.isEpic && item.type !== "heal"); // Only non-epic items can drop
                if (availableEquipmentDrops.length > 0) {
                    const droppedItem = availableEquipmentDrops[Math.floor(Math.random() * availableEquipmentDrops.length)];

                    // Check for inventory limit (5 items) or duplicate
                    if (player.equippedItems.length >= MAX_EQUIPPED_ITEMS || player.equippedItems.some(eq => eq.name === droppedItem.name)) {
                        const soldValue = Math.floor(droppedItem.sellValue || droppedItem.cost / 2);
                        player.coins += soldValue;
                        battleRewards.equipment.push(`Found ${droppedItem.name} ${droppedItem.icon}, but inventory full/duplicate! Sold for ${soldValue} coins.`);
                    } else {
                        player.equippedItems.push({ // Add to equippedItems array
                            name: droppedItem.name,
                            icon: droppedItem.icon,
                            attack: droppedItem.attack || 0,
                            defense: droppedItem.defense || 0,
                            sellValue: droppedItem.sellValue || Math.floor(droppedItem.cost / 2)
                        });
                        battleRewards.equipment.push(`${droppedItem.name} ${droppedItem.icon}`);
                        itemSound.triggerAttackRelease(["C5", "G5"], "8n", Tone.now());
                    }
                }
            }

            // Potion Drop (15% chance for regular, 30% for elite)
            const potionDropChance = eliteEnemies.some(e => e.name === currentEnemy.name) ? 0.3 : 0.15;
            if (Math.random() < potionDropChance) {
                player.potions++;
                battleRewards.equipment.push(`Healing Potion üß™`);
                itemSound.triggerAttackRelease(["C6", "E6"], "8n", Tone.now());
            }


            // Check for victory if final boss is defeated
            if (currentEnemy.isFinalBoss) {
                setMessage("üéâ You defeated the Final Boss! Your legend is complete!");
                playVictoryAnimation(); // Play victory animation
                victorySound.triggerAttackRelease(["C5", "E5", "G5", "C6"], "2n", Tone.now());
                player.hasFoughtFinalBoss = true; // Mark final boss as fought
                endGame(true); // Player defeated final boss
                return;
            } else if (eliteEnemies.some(e => e.name === currentEnemy.name)) {
                setMessage("üéâ You defeated the Elite Monster! Your legend grows!");
                victorySound.triggerAttackRelease(["C5", "E5", "G5", "C6"], "2n", Tone.now());
            }

            player.encountersFought++; // Use player.encountersFought
            checkLevelUp();
            player.hp = Math.min(player.maxHp, Math.floor(player.hp + player.maxHp * 0.1)); // Heal a bit after battle, ensure integer HP
            updatePlayerStats();
            showBattleResult(battleRewards.xp, battleRewards.coins, battleRewards.equipment);
        }

        /**
         * Checks if the player has enough XP to level up.
         */
        function checkLevelUp() {
            if (player.xp >= player.xpToNextLevel) {
                player.level++;
                player.xp -= player.xpToNextLevel; // Carry over excess XP
                player.xpToNextLevel = xpRequirements[player.level] || Math.floor(player.xpToNextLevel * 1.5); // Use defined XP or scale

                // Apply level-based skill upgrade
                if (occupations[player.occupation].skills[player.level]) {
                    player.skillName = occupations[player.occupation].skills[player.level].name;
                    player.skillIcon = occupations[player.occupation].skills[player.level].icon;
                    player.skillEffect = occupations[player.occupation].skills[player.level].effect;
                }

                player.maxHp = Math.floor(player.maxHp * 1.15); // Increase max HP
                player.hp = player.maxHp; // Fully heal on level up
                player.attack = Math.floor(player.attack * 1.1); // Increase attack
                player.defense = Math.floor(player.defense * 1.1); // Increase defense
                setMessage(`üåü You levelled up to Level ${player.level}! Your stats have increased!`);
                levelUpSound.triggerAttackRelease(["C4", "E4", "G4"], "8n", Tone.now()); // Play level up sound
                updatePlayerStats();
            }
        }

        /**
         * Handles the player fleeing from battle.
         */
        function flee() {
            setMessage("You managed to flee from the battle!");
            player.hp = Math.max(1, Math.floor(player.hp - player.maxHp * 0.1)); // Lose some HP for fleeing, ensure integer HP
            updatePlayerStats();
            showMainMenu(); // Return to main menu after fleeing
        }

        /**
         * Shows the shop screen.
         */
        function showShop() {
            mainMenuActions.classList.add('hidden');
            shopScreen.classList.remove('hidden');
            setMessage("Welcome to the Wanderer's Shop! What do you need?");
            renderShopItems();
            renderEquippedItemsForSell();
        }

        /**
         * Renders items available in the shop.
         */
        function renderShopItems() {
            shopItemsContainer.innerHTML = '';
            // Filter out epic items for shop display (only epic items should be here)
            const itemsToShow = fullShopItemPool.filter(item => item.isEpic || item.type === "heal"); // Only epic or healing potions in shop

            itemsToShow.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('shop-item', 'btn-secondary');
                itemDiv.innerHTML = `
                    <div class="text-3xl">${item.icon}</div>
                    <div class="shop-item-name">${item.name}</div>
                    <div class="text-sm text-gray-300 mb-2">${item.description}</div>
                    <div class="shop-item-cost">Cost: ${item.cost} Coins</div>
                    <button class="btn btn-primary mt-2 text-sm" onclick="buyItem('${item.name}')" ${player.coins < item.cost || (item.type !== 'heal' && (player.equippedItems.length >= MAX_EQUIPPED_ITEMS || player.equippedItems.some(eq => eq.name === item.name))) ? 'disabled' : ''}>Buy</button>
                `;
                shopItemsContainer.appendChild(itemDiv);
            });
        }

        /**
         * Renders equipped items for selling in the shop.
         */
        function renderEquippedItemsForSell() {
            equippedItemsSellContainer.innerHTML = '';
            if (player.equippedItems.length === 0) {
                equippedItemsSellContainer.innerHTML = '<p class="text-gray-400">You have no equipment to sell.</p>';
                return;
            }

            player.equippedItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('equipped-item', 'btn-secondary');
                let effect = [];
                if (item.attack > 0) effect.push(`Atk +${item.attack}`);
                if (item.defense > 0) effect.push(`Def +${item.defense}`);
                itemDiv.innerHTML = `
                    <div class="text-3xl">${item.icon}</div>
                    <div class="equipped-item-name">${item.name}</div>
                    <div class="text-sm text-gray-300 mb-2">(${effect.join(', ')})</div>
                    <div class="equipped-item-sell-value">Sell: ${item.sellValue} Coins</div>
                    <button class="btn btn-danger mt-2 text-sm" onclick="sellEquipment(${index})">Sell</button>
                `;
                equippedItemsSellContainer.appendChild(itemDiv);
            });
        }

        /**
         * Handles buying an item from the shop.
         * @param {string} itemName - The name of the item to buy.
         */
        function buyItem(itemName) {
            const item = fullShopItemPool.find(i => i.name === itemName); // Find from full pool
            if (!item || player.coins < item.cost) {
                setMessage("Not enough coins!");
                return;
            }

            // Check for inventory limit (5 items) or duplicate for non-healing items
            if (item.type !== "heal" && (player.equippedItems.length >= MAX_EQUIPPED_ITEMS)) {
                setMessage("Your equipment inventory is full! Sell some items to make space.");
                return;
            }

            if (item.type !== "heal" && player.equippedItems.some(eq => eq.name === item.name)) {
                setMessage("You already own this equipment! Cannot buy a duplicate.");
                return;
            }

            player.coins -= item.cost;
            coinSound.triggerAttackRelease(["C5", "G5"], "8n", Tone.now()); // Play coin sound

            if (item.type === "heal") {
                player.potions++;
                setMessage(`You bought a ${item.name}! Potions: ${player.potions}`);
            } else {
                // Add equipment to the equippedItems array
                player.equippedItems.push({
                    name: item.name,
                    icon: item.icon,
                    attack: item.attack || 0,
                    defense: item.defense || 0,
                    sellValue: item.sellValue || Math.floor(item.cost / 2)
                });
                setMessage(`You bought and equipped a ${item.name}!`);
            }
            updatePlayerStats();
            renderShopItems(); // Re-render shop to update buy button states
            renderEquippedItemsForSell(); // Update sell list
        }

        /**
         * Handles selling an equipped item.
         * @param {number} index - The index of the item in the equippedItems array.
         */
        function sellEquipment(index) {
            if (index < 0 || index >= player.equippedItems.length) return;

            const itemToSell = player.equippedItems[index];
            player.coins += itemToSell.sellValue;
            player.equippedItems.splice(index, 1); // Remove item
            coinSound.triggerAttackRelease(["C5", "G5"], "8n", Tone.now());
            setMessage(`You sold ${itemToSell.name} for ${itemToSell.sellValue} coins!`);
            updatePlayerStats();
            renderEquippedItemsForSell(); // Re-render sell list
        }


        /**
         * Leaves the shop and returns to main menu.
         */
        function returnToMainMenu() {
            shopScreen.classList.add('hidden');
            hireScreen.classList.add('hidden');
            showMainMenu();
        }

        /**
         * Shows the hire companion screen.
         */
        function showHireScreen() {
            mainMenuActions.classList.add('hidden');
            hireScreen.classList.remove('hidden');
            setMessage("A mysterious figure offers a companion. Who will you hire?");
            renderHireOptions();
        }

        /**
         * Renders companion options.
         */
        function renderHireOptions() {
            hireOptionsContainer.innerHTML = '';
            Object.values(companions).forEach(comp => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('hire-option', 'btn-secondary');
                // Disable if player already has a companion OR not enough coins
                const isDisabled = player.coins < comp.cost || player.companion;
                optionDiv.innerHTML = `
                    <div class="text-3xl">${comp.icon}</div>
                    <div class="hire-option-name">${comp.name}</div>
                    <div class="hire-option-cost">Cost: ${comp.cost} Coins</div>
                    <div class="text-sm text-gray-300 mb-2">${comp.description}</div>
                    <button class="btn btn-primary mt-2 text-sm" onclick="hireCompanion('${comp.name}')" ${isDisabled ? 'disabled' : ''}>Hire</button>
                `;
                hireOptionsContainer.appendChild(optionDiv);
            });
            // Add a dismiss button if a companion exists
            if (player.companion) {
                const dismissDiv = document.createElement('div');
                dismissDiv.classList.add('hire-option', 'btn-danger');
                dismissDiv.innerHTML = `
                    <div class="text-3xl">üö´</div>
                    <div class="hire-option-name">Dismiss Companion</div>
                    <div class="text-sm text-gray-300 mb-2">Dismiss your current companion.</div>
                    <button class="btn btn-danger mt-2 text-sm" onclick="dismissCompanion()">Dismiss</button>
                `;
                hireOptionsContainer.appendChild(dismissDiv);
            }
        }

        /**
         * Handles hiring a companion.
         * @param {string} companionName - The name of the companion to hire.
         */
        function hireCompanion(companionName) {
            const companion = companions[companionName];
            // Check if player already has a companion
            if (player.companion) {
                setMessage("You already have a companion. Dismiss them first if you wish to hire a new one.");
                return;
            }
            if (!companion || player.coins < companion.cost) {
                setMessage("Cannot hire this companion! Not enough coins or invalid companion.");
                return;
            }

            player.coins -= companion.cost;
            player.companion = { // Assign directly to player.companion
                name: companion.name,
                icon: companion.icon,
                type: companion.name.replace(/\s/g, ''),
                effect: companion.effect,
                frequency: companion.frequency
            };
            itemSound.triggerAttackRelease(["C5", "G5"], "8n", Tone.now()); // Use item sound for hiring
            setMessage(`You hired a ${companion.name}! They will join your adventure.`);
            updatePlayerStats();
            returnToMainMenu();
        }

        /**
         * Dismisses the current companion.
         */
        function dismissCompanion() {
            if (!player.companion) return;
            setMessage(`You dismissed your ${player.companion.name} companion.`);
            player.companion = null;
            updatePlayerStats();
            renderHireOptions(); // Re-render options to reflect dismissal
        }

        /**
         * Shows the restart confirmation modal.
         */
        function showRestartConfirmation() {
            // Hide all main game elements
            mainMenuActions.classList.add('hidden');
            battleActions.classList.add('hidden');
            enemyDisplay.classList.add('hidden');
            shopScreen.classList.add('hidden');
            hireScreen.classList.add('hidden');
            restartBtn.classList.add('hidden'); // Hide the restart button itself while modal is open
            finalBossPrepModal.classList.add('hidden'); // Hide final boss prep modal if open

            confirmModal.classList.remove('hidden');
            setMessage("Are you sure you want to restart the game?");
        }

        /**
         * Handles the restart confirmation.
         * @param {boolean} confirm - True if the user confirmed restart, false otherwise.
         */
        function confirmRestart(confirm) {
            confirmModal.classList.add('hidden');
            if (confirm) {
                restartGame();
            } else {
                // If not confirmed, go back to previous state
                if (currentEnemy) { // If in battle, show battle buttons
                    mainMenuActions.classList.add('hidden');
                    battleActions.classList.remove('hidden');
                    enemyDisplay.classList.remove('hidden');
                    setMessage(`You are still fighting the ${currentEnemy.name}!`);
                } else if (!shopScreen.classList.contains('hidden')) {
                    showShop(); // Return to shop if it was open
                } else if (!hireScreen.classList.contains('hidden')) {
                    showHireScreen(); // Return to hire screen if it was open
                } else if (!finalBossPrepModal.classList.contains('hidden')) { // If final boss prep was open
                    finalBossPrepModal.classList.remove('hidden');
                    setMessage("The Final Challenge Awaits!");
                }
                else {
                    showMainMenu(); // Otherwise, show main menu
                }
                restartBtn.classList.remove('hidden'); // Always show restart button after modal closes
            }
        }

        /**
         * Shows the battle result modal.
         * @param {number} xp - XP gained.
         * @param {number} coins - Coins gained.
         * @param {Array<string>|null} equipment - Array of equipment messages.
         */
        function showBattleResult(xp, coins, equipment) {
            resultTitle.textContent = "Battle Won!";
            resultXp.textContent = `XP Gained: ${xp}`;
            resultCoins.textContent = `Coins Found: ${coins} üí∞`;
            resultEquipment.innerHTML = equipment.length > 0 ? `Items Found: ${equipment.join('<br>')}` : "No special items found."; // Use innerHTML for line breaks
            battleResultModal.classList.remove('hidden');
            setMessage("Battle concluded!"); // Set main message
        }

        /**
         * Closes the battle result modal.
         */
        function closeBattleResult() {
            battleResultModal.classList.add('hidden');
            showMainMenu(); // Return to main menu after battle result
        }

        /**
         * Plays a victory animation with confetti.
         */
        function playVictoryAnimation() {
            const confettiContainer = document.createElement('div');
            confettiContainer.style.position = 'fixed';
            confettiContainer.style.top = '0';
            confettiContainer.style.left = '0';
            confettiContainer.style.width = '100%';
            confettiContainer.style.height = '100%';
            confettiContainer.style.overflow = 'hidden';
            confettiContainer.style.pointerEvents = 'none';
            confettiContainer.style.zIndex = '9999';
            document.body.appendChild(confettiContainer);

            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 70%)`; // Random colours
                confettiContainer.appendChild(confetti);
            }

            setTimeout(() => {
                confettiContainer.remove();
            }, 3000); // Remove confetti after 3 seconds
        }

        /**
         * Shows the game over/victory modal.
         * @param {boolean} isVictory - True if the game ended in victory.
         */
        function endGame(isVictory) {
            mainMenuActions.classList.add('hidden');
            battleActions.classList.add('hidden');
            enemyDisplay.classList.add('hidden');
            restartBtn.classList.add('hidden'); // Hide the regular restart button
            finalBossPrepModal.classList.add('hidden'); // Ensure final boss prep modal is hidden

            gameOverModal.classList.remove('hidden');
            if (isVictory) {
                gameOverTitle.textContent = "VICTORY ACHIEVED!";
                gameOverMessage.textContent = "You have bravely faced and overcome the ultimate challenge, proving yourself a true hero of the realm! Your legend will be sung for ages.";
                victorySound.triggerAttackRelease(["C5", "E5", "G5", "C6"], "2n", Tone.now());
                playVictoryAnimation(); // Trigger confetti for victory
            } else {
                gameOverTitle.textContent = "GAME OVER!";
                gameOverMessage.textContent = "Your adventure ends here. Though defeated, your spirit remains. Rise again, hero, and forge a new destiny!";
                defeatSound.triggerAttackRelease(["C3", "A2", "F2"], "1n", Tone.now());
            }
        }

        /**
         * Restarts the entire game.
         */
        function restartGame() {
            occupationScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            gameOverModal.classList.add('hidden'); // Hide game over modal
            restartBtn.classList.add('hidden'); // Hide restart button on occupation screen
            finalBossPrepModal.classList.add('hidden'); // Hide final boss prep modal
            // Reset player object which includes encountersFought and battlesSinceLastFromHell
            currentEnemy = null;
            player = {}; // Clear player data
            playerDebuffTurns = 0; // Reset debuff
            enemyShieldTurns = 0; // Reset shield
            enemyImmunityTurns = 0; // Reset immunity
            enemyStrengthTurns = 0; // Reset strength
            setMessage("Choose Your Path");
        }
    </script>
</body>
</html>
